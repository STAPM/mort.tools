---
title: "Mortality rate calculation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Mortality rate calculation}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
bibliography: mort-refs.bib
header-includes:
  \usepackage{float}
  \usepackage{amsmath}
link-citations: yes
citation_package: natbib
biblio-style: vancouver
urlcolor: blue
---


Aim: To calculate the one year central rates of death from diseases defined by specific ICD-10 codes, stratified by specified population subgroups.   

## Preliminaries

- Get access to the data on the `heta-study` VM.  
- Get access to the STAPM Gitlab organisation.  
- [Choose a repo](mort-tools.html) as a starting point and get the code on the VM.  

## Read the death and population counts data
The functions `mort.tools::ReadPopData()` and `mort.tools::ReadData()` have been written to read the data in the format that it was provided by the data providers and output the data in a nicely formatted form ready for further processing. Depending on the objective for processing, you might then need to filter the data to select only specific geographic regions. You might also need to collapse some of the dimensionality in the data, e.g. if you do not need separate counts of deaths for males and females, then you will need to sum the counts of deaths and population numbers across the sexes. 

```{r loadmortpopdata, eval = F}
# Load the population counts by age, sex, IMD quintile, local authority, year
pop_data <- mort.tools::ReadPopData(path = "D:/Death and population data")

# Load the death counts by age, sex, IMD quintile, local authority, year and cause
data <- mort.tools::ReadData(path = "D:/Death and population data")

```

## Grouping deaths by cause
Deaths in the mortality data are assigned a single ICD-10 code e.g. C00, but for our analysis we need to group these into cause-groups according to the groups defined in our lists of tobacco and alcohol related diseases [@Angus2018;@webster2018risk]. To do this, we create a new column that defines each group by its constituent ICD-10 codes e.g. "C00-C06" becomes the single codes C00, C01, C02, C03, C04, C05, and C06. These are stored in [tobalcepi::tob_icd10_lookups](https://stapm.gitlab.io/r-packages/tobalcepi/reference/tob_icd10_lookups.html), [tobalcepi::alc_icd10_lookups](https://stapm.gitlab.io/r-packages/tobalcepi/reference/alc_icd10_lookups.html), and [tobalcepi::tobalc_icd10_lookups](https://stapm.gitlab.io/r-packages/tobalcepi/reference/tobalc_icd10_lookups.html). We use the function [tobalcepi::ExpandCodes()](https://stapm.gitlab.io/r-packages/tobalcepi/reference/ExpandCodes.html) to convert these ICD-10 lookups to 'long' form, and use the resulting data table to map the single ICD-10 codes to disease groups. This mapping is done by the function `mort.tools::GroupCauses()`.   

### Oesophageal cancer SCC-AC splits
Oesophageal cancer is defined by the ICD-10 code "C15". It has two subtypes "SCC" and "AC" - these subtypes have different risk relationships to tobacco and alcohol but they are not easy to identify based on the ICD-10 coding system. We therefore use some external data to estimate how total oesophageal cancers might be divided between the subtypes (see our disease list reports [@Angus2018;@webster2018risk]). The data for splitting is in `mort.tools::oesoph_splits` and the function that does the splitting is `mort.tools::SplitOesoph()`, which is called by `mort.tools::GroupCauses()`.  

### Zero deaths
There might be some population subgroups for which there have been no deaths from a particular cause, and rows with zero deaths needed to be added in these cases.  

```{r grpbycause, eval = F}
# Generate the relevant lookup file
lookups <- tobalcepi::ExpandCodes(tob_icd10_lookups)

# Group death data into causes
data <- mort.tools::GroupCauses(data, lookups, strat_vars = c("year", "age", "sex", "imd_quintile"))

# Where there have been no deaths from a particular cause within a particular subgroup,
# add new rows that have n_deaths = 0
domain <- data.frame(expand.grid(
  year = unique(data$year),
  age = unique(data$age),
  sex = unique(data$sex),
  imd_quintile = unique(data$imd_quintile),
  cause = unique(data$cause)
))
setDT(domain)

data <- merge(domain, data, by = c("year", "age", "sex", "imd_quintile", "cause"), all.x = T, all.y = F)

data[is.na(n_deaths), n_deaths := 0]

```

## Calculate the central death rates
The cause-specific central death rates can now be calculated for each population subgroup by dividing the annual number of deaths from each cause by the mid-year population size.  

```{r calcrates, eval = F}
# Merge the deaths and population counts
data <- merge(data, pop_data, by = c("year", "age", "sex", "imd_quintile"), all = T)

# Calculate the central death rates
data[ , mx_cause := n_deaths / pops]

# Check looks ok
data[ , .(n_deaths = sum(n_deaths)), by = "cause"]

# write data

# note the package version so the data can be tagged with it
ver <- packageVersion("mort.tools")

write.table(data, paste0("outputs/tob_death_rates_england_national_", Sys.Date(), "_mort.tools_", ver, ".csv"),
  row.names = F, sep = ",")

```

## References
